<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <title>Anna's jQuery Week Calendar</title>
  <link rel='stylesheet' type='text/css' href='libs/css/smoothness/jquery-ui-1.8.11.custom.css' />
  <link rel='stylesheet' type='text/css' href='css/jquery.weekcalendar.css' />
  <link rel='stylesheet' type='text/css' href='aliasWeekCal_json.css' />
  <script type='text/javascript' src='libs/jquery-1.4.4.min.js'></script>
  <script type='text/javascript' src='libs/jquery-ui-1.8.11.custom.min.js'></script>
  <script type='text/javascript' src='libs/date.js'></script>
  <script type='text/javascript' src='libs/jquery.weekcalendar.js'></script>
  <script type='text/javascript'>
      var CLIENT_ID = '935855233873-lj1dg1jvkis1npb7bpmlv8b8ksauqg03.apps.googleusercontent.com';
      var CALENDAR_ID = 'k2rb1nfsbkmli8uvqqh6ru465c@group.calendar.google.com';
      var SCOPES = ["https://www.googleapis.com/auth/calendar"];

      /**
       * Check if current user has authorized this application.
       */
      function checkAuth() {
        gapi.auth.authorize(
          {
            'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          }, handleAuthResult);
      }

      /**
       * Handle response from authorization server.
       *
       * @param {Object} authResult Authorization result.
       */
      function handleAuthResult(authResult) {
        var authorizeDiv = document.getElementById('authorize-div');
        if (authResult && !authResult.error) {
          // Hide auth UI, then load client library.
          authorizeDiv.style.display = 'none';
          loadCalendarApi();
        } else {
          // Show auth UI, allowing the user to initiate authorization by
          // clicking authorize button.
          authorizeDiv.style.display = 'inline';
        }
      }

      /**
       * Initiate auth flow in response to user clicking authorize button.
       *
       * @param {Event} event Button click event.
       */
      function handleAuthClick(event) {
        gapi.auth.authorize(
          {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
          handleAuthResult);
        return false;
      }

      /**
       * Load Google Calendar client library. List upcoming events
       * once client library is loaded.
       */
      function loadCalendarApi() {
        gapi.client.load('calendar', 'v3', listUpcomingEvents);
      }

      /**
       * Print the summary and start datetime/date of the next ten events in
       * the authorized user's calendar. If no events are found an
       * appropriate message is printed.
       */
      function listUpcomingEvents() {
        var startDate = new Date(2016, 1, 4);
        var request = gapi.client.calendar.events.list({
          'calendarId': CALENDAR_ID,
          'timeMin': startDate.toISOString(),
//          'timeMin': (new Date()).toISOString(),
          'showDeleted': false,
          'singleEvents': true,
          'maxResults': 10,
          'orderBy': 'startTime'
        });

        request.execute(function(resp) {

          var jsonArray = resp.items;
		  var jsonToCal = '[';
		  for(var i = 0; i < jsonArray.length; i++ ) {
			  jsonToCal += '{';
			  jsonToCal += '\"id\":' + (i+1);
			  jsonToCal += ',';
			  jsonToCal += '\"start\":\"' + jsonArray[i].start.dateTime + '\"';
			  jsonToCal += ',';
			  jsonToCal += '\"end\":\"' + jsonArray[i].end.dateTime + '\"';
			  jsonToCal += ',';
			  jsonToCal += '\"title\":\"\"'; 
//			  jsonToCal += '\"title\":\"' + jsonArray[i].summary + '\"'; 
			  jsonToCal += '}';
			  if(i < jsonArray.length-1) 
				  jsonToCal += ',';
		  }
		  jsonToCal += ']';

          var eventData = JSON.parse(jsonToCal);
          
//		  var year = new Date().getFullYear();
//		  var month = new Date().getMonth();
//		  var day = new Date().getDate();
		  
		  var now = new Date();
		  var oneMonthLater = new Date().setMonth(now.getMonth);

		  $(document).ready(function() {
		  
			$('#calendar').weekCalendar({
			  data: eventData,
			  date: now,
			  minDate: now,
			  maxDate: oneMonthLater,
			  switchDisplay: {'1 day': 1,'3 days': 3,'Work week': 5, 'Full week': 7},
			  timeslotsPerHour: 4,
			  height: function($calendar) {
				return $(window).height() - $('h1').outerHeight() - $('.description').outerHeight();
			  },
			  eventRender: function(calEvent, $event) {
				if (calEvent.end.getTime() < new Date().getTime()) {
				  $event.css('backgroundColor', '#aaa');
				  $event.find('.time').css({
				    backgroundColor: '#999',
				    border:'1px solid #888'
				  });
				}
			  },
			  eventNew: function(calEvent, $event) {
				displayMessage('<strong>Added event</strong><br/>Start: ' + calEvent.start + '<br/>End: ' + calEvent.end);
				alert('You\'ve added a new event. You would capture this event, add the logic for creating a new event with your own fields, data and whatever backend persistence you require.');
			  },
			  eventDrop: function(calEvent, $event) {
				displayMessage('<strong>Moved Event</strong><br/>Start: ' + calEvent.start + '<br/>End: ' + calEvent.end);
			  },
			  eventResize: function(calEvent, $event) {
				displayMessage('<strong>Resized Event</strong><br/>Start: ' + calEvent.start + '<br/>End: ' + calEvent.end);
			  },
			  eventClick: function(calEvent, $event) {
				displayMessage('<strong>Clicked Event</strong><br/>Start: ' + calEvent.start + '<br/>End: ' + calEvent.end);
			  },
			  eventMouseover: function(calEvent, $event) {
				displayMessage('<strong>Mouseover Event</strong><br/>Start: ' + calEvent.start + '<br/>End: ' + calEvent.end);
			  },
			  eventMouseout: function(calEvent, $event) {
				displayMessage('<strong>Mouseout Event</strong><br/>Start: ' + calEvent.start + '<br/>End: ' + calEvent.end);
			  },
			  noEvents: function() {
				displayMessage('There are no events for this week');
			  },
			  reachedmindate: function($calendar, date) {
				displayMessage('You reached mindate');
			  },
			  reachedmaxdate: function($calendar, date) {
				displayMessage('You cannot go further');
			  }
			});

			function displayMessage(message) {
			  $('#message').html(message).fadeIn();
			}

			$('<div id="message" class="ui-corner-all"></div>').prependTo($('body'));
		  });
          
        });
      }
  

</script>
<script src="https://apis.google.com/js/client.js?onload=checkAuth">
</script>
</head>
<body>
  <h1>Anna's Week Calendar with JSON data source</h1>

  <p class="description">
    This is Anna's test weekly calendar
  </p>


  <div id="calendar"></div>
      <div id="authorize-div" style="display: none">
      <span>Authorize access to Google Calendar API</span>
      <!--Button for the user to click to initiate auth sequence -->
      <button id="authorize-button" onclick="handleAuthClick(event)">
        Authorize
      </button>
    </div>

</body>
</html>
